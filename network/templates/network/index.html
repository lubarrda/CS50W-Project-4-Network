{% extends "network/layout.html" %}

{% block body %}
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function submitrequest(id) {
            const textareaValue = document.getElementById(`textarea_${id}`).value;
            fetch(`/edit/${id}`, {
                method: "POST",
                headers: { "Content-type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
                body: JSON.stringify({
                    content: textareaValue
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(result => {
                    // updating
                    document.getElementById(`content_${id}`).innerText = result.data;

                    // hidding modal.
                    $(`#modal_edit_post_${id}`).modal('hide');
                })
                .catch(error => {
                    console.log("There was a problem with the fetch operation:", error.message);
                });
        }
    </script>

<div class="container mt-4">
    <h1>All Posts</h1>

    {% if user.is_authenticated %}
    <div class="newPost card mt-3">
        <div class="card-header">
            <h2>New Post</h2>
        </div>
        <div class="card-body">
            <form action="{% url 'new_post' %} " method="post">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" class="form-control" rows="4"
                        placeholder="Something to share...?"></textarea>
                </div>
                <input type="submit" value="Post" class="btn btn-primary" />
            </form>
        </div>
    </div>
    {% endif %}

    <div class="allPost">
        {% for post in page_posted %}
            <div class="post mx-5 my-3">
                <h5 class="username mb-1">@{{ post.user }}</h5>
                <h6 class="content" id="content_{{ post.id }}" mb-1">{{ post.content }}</h6>
                <p class="date mb-0">{{ post.date }}</p>
                {% if user.is_authenticated %}
                    {% if user == post.user %}
                    <div class="d-flex">
                        <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#modal_edit_post_{{ post.id }}">Edit</button> 
                    </div>
                    <div class="modal fade" id="modal_edit_post_{{ post.id }}" tabindex="-1" role="dialog" aria-labelledby="modal_edit_post_{{ post.id }}_label" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title">Edit Post</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                                <textarea rows="5" id="textarea_{{ post.id }}" class="form-control" name="content">{{ post.content}}</textarea>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-primary" onclick="submitrequest( {{ post.id }} )">Save changes</button>
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                {% endif %}

            </div>
        {% endfor %}
    </div>
    
    <nav aria-label="Page navigation" class="text-center">
        {% if page_posted.has_next %}
            <a class="page-link central-btn" href="?page={{ page_posted.next_page_number }}">Next</a>
        {% elif not page_posted.has_next and page_posted.number != 1 %}
            <a class="page-link central-btn" href="?page={{ page_posted.previous_page_number }}">Back</a>
        {% endif %}
    </nav>

</div>
{% endblock %}
